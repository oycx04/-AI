# 阿里云服务器部署指南 🚀

亲爱的主人，这里是完整的阿里云部署教程！

## 📋 部署前准备

### 1. 服务器要求
- **操作系统**: Ubuntu 20.04+ 或 CentOS 7+
- **内存**: 至少 2GB RAM
- **存储**: 至少 20GB 可用空间
- **网络**: 开放端口 80, 443, 22

### 2. 域名配置
- 域名: `15468597.top`
- 需要在阿里云DNS中添加A记录指向服务器IP

## 🛠️ 部署步骤

### 步骤1: 连接服务器
```bash
# 使用SSH连接到阿里云服务器
ssh root@你的服务器IP
```

### 步骤2: 安装Docker和Docker Compose
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 启动Docker服务
sudo systemctl start docker
sudo systemctl enable docker

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### 步骤3: 上传项目文件
```bash
# 在本地打包项目（排除不必要文件）
tar -czf ai-app.tar.gz --exclude='.git' --exclude='node_modules' --exclude='__pycache__' .

# 上传到服务器
scp ai-app.tar.gz root@你的服务器IP:/root/

# 在服务器上解压
cd /root
tar -xzf ai-app.tar.gz
cd ai应用（1）
```

### 步骤4: 配置环境变量
```bash
# 创建生产环境配置
cp .env.production .env

# 编辑环境变量
nano .env
```

确保包含以下配置：
```env
FLASK_ENV=production
DATABASE_TYPE=simple
JWT_SECRET_KEY=your-super-secret-key-here
DOMAIN=15468597.top
```

### 步骤5: 启动服务
```bash
# 构建并启动所有服务
docker-compose -f docker-compose.prod.yml up -d --build

# 查看服务状态
docker-compose -f docker-compose.prod.yml ps

# 查看日志
docker-compose -f docker-compose.prod.yml logs -f
```

### 步骤6: 配置Nginx和SSL
```bash
# 安装Certbot（用于SSL证书）
sudo apt install certbot python3-certbot-nginx -y

# 获取SSL证书
sudo certbot --nginx -d 15468597.top

# 设置自动续期
sudo crontab -e
# 添加这行：0 12 * * * /usr/bin/certbot renew --quiet
```

## 🔧 常用管理命令

### 查看服务状态
```bash
docker-compose -f docker-compose.prod.yml ps
```

### 重启服务
```bash
docker-compose -f docker-compose.prod.yml restart
```

### 更新代码
```bash
# 拉取最新代码
git pull origin main

# 重新构建并启动
docker-compose -f docker-compose.prod.yml up -d --build
```

### 查看日志
```bash
# 查看所有服务日志
docker-compose -f docker-compose.prod.yml logs -f

# 查看特定服务日志
docker-compose -f docker-compose.prod.yml logs -f backend
docker-compose -f docker-compose.prod.yml logs -f frontend
```

## 🚨 故障排除

### 1. 端口被占用
```bash
# 查看端口占用
sudo netstat -tlnp | grep :80
sudo netstat -tlnp | grep :443

# 停止占用端口的服务
sudo systemctl stop apache2  # 如果安装了Apache
sudo systemctl stop nginx    # 如果有其他Nginx实例
```

### 2. 内存不足
```bash
# 查看内存使用
free -h

# 创建交换文件（如果需要）
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

### 3. 防火墙配置
```bash
# Ubuntu/Debian
sudo ufw allow 22
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=22/tcp
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --reload
```

## 📊 监控和维护

### 设置监控脚本
```bash
# 创建健康检查脚本
cat > /root/health-check.sh << 'EOF'
#!/bin/bash
if ! curl -f http://localhost/health > /dev/null 2>&1; then
    echo "Service is down, restarting..."
    cd /root/ai应用（1）
    docker-compose -f docker-compose.prod.yml restart
fi
EOF

chmod +x /root/health-check.sh

# 添加到定时任务
echo "*/5 * * * * /root/health-check.sh" | crontab -
```

## 🎉 部署完成

部署成功后，你可以通过以下方式访问：
- **HTTP**: http://15468597.top
- **HTTPS**: https://15468597.top

恭喜主人！你的AI应用已经成功部署到阿里云服务器了！ ✨

如果遇到任何问题，随时告诉我，我会帮你解决的~ 💕