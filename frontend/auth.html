<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户登录 - AI学习助手</title>
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <style>
        .auth-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .auth-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 25px 45px rgba(0, 0, 0, 0.1);
        }
        .input-group {
            position: relative;
        }
        .input-group input:focus + label,
        .input-group input:not(:placeholder-shown) + label {
            transform: translateY(-20px) scale(0.8);
            color: #667eea;
        }
        .input-group label {
            position: absolute;
            left: 12px;
            top: 12px;
            transition: all 0.3s ease;
            pointer-events: none;
            color: #6b7280;
        }
        .avatar-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
    </style>
</head>
<body class="auth-container min-h-screen">
    <!-- 统一导航栏将通过JavaScript动态插入 -->
    
    <!-- 主要内容区域 -->
    <div class="flex items-center justify-center p-4 pt-32">
    <div class="auth-card rounded-2xl p-8 w-full max-w-md">
        <!-- 头部 -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mb-4">
                <i class="fas fa-graduation-cap text-white text-2xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">AI学习助手</h1>
            <p class="text-gray-600">开启你的智能学习之旅</p>
        </div>

        <!-- 登录表单 -->
        <form id="loginForm" class="space-y-6">
            <div class="input-group">
                <input 
                    type="text" 
                    id="loginUsername" 
                    name="username" 
                    placeholder=" " 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                    required
                >
                <label for="loginUsername">用户名或邮箱</label>
            </div>

            <div class="input-group">
                <input 
                    type="password" 
                    id="loginPassword" 
                    name="password" 
                    placeholder=" " 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                    required
                >
                <label for="loginPassword">密码</label>
            </div>

            <button 
                type="submit" 
                class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-700 transition-all transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            >
                <i class="fas fa-sign-in-alt mr-2"></i>登录
            </button>
        </form>

        <!-- 注册表单 -->
        <form id="registerForm" class="space-y-6 hidden">
            <div class="input-group">
                <input 
                    type="text" 
                    id="registerUsername" 
                    name="username" 
                    placeholder=" " 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                    required
                >
                <label for="registerUsername">用户名</label>
            </div>

            <div class="input-group">
                <input 
                    type="email" 
                    id="registerEmail" 
                    name="email" 
                    placeholder=" " 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                    required
                >
                <label for="registerEmail">邮箱</label>
            </div>

            <div class="input-group">
                <input 
                    type="password" 
                    id="registerPassword" 
                    name="password" 
                    placeholder=" " 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                    required
                    minlength="6"
                >
                <label for="registerPassword">密码（至少6位）</label>
            </div>

            <div class="input-group">
                <input 
                    type="password" 
                    id="confirmPassword" 
                    name="confirmPassword" 
                    placeholder=" " 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                    required
                >
                <label for="confirmPassword">确认密码</label>
            </div>

            <div class="input-group relative">
                <input 
                    type="text" 
                    id="registerSchool" 
                    name="school" 
                    placeholder=" " 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                    required
                    autocomplete="off"
                >
                <label for="registerSchool">学校</label>
                <div id="schoolSuggestions" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto z-10 hidden">
                    <!-- 学校建议列表将在这里动态生成 -->
                </div>
            </div>

            <button 
                type="submit" 
                class="w-full bg-gradient-to-r from-green-500 to-blue-600 text-white py-3 rounded-lg font-semibold hover:from-green-600 hover:to-blue-700 transition-all transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
            >
                <i class="fas fa-user-plus mr-2"></i>注册
            </button>
        </form>

        <!-- 切换按钮 -->
        <div class="mt-6 text-center">
            <button 
                id="switchToRegister" 
                class="text-blue-600 hover:text-blue-800 font-medium transition-colors"
            >
                还没有账号？立即注册
            </button>
            <button 
                id="switchToLogin" 
                class="text-blue-600 hover:text-blue-800 font-medium transition-colors hidden"
            >
                已有账号？立即登录
            </button>
        </div>

        <!-- 错误提示 -->
        <div id="errorMessage" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span id="errorText"></span>
        </div>

        <!-- 成功提示 -->
        <div id="successMessage" class="mt-4 p-3 bg-green-100 border border-green-400 text-green-700 rounded-lg hidden">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="successText"></span>
        </div>
    </div>

    <!-- 用户信息显示（登录后） -->
    <div id="userProfile" class="auth-card rounded-2xl p-8 w-full max-w-md hidden">
        <div class="text-center">
            <div id="userAvatar" class="avatar-circle mx-auto mb-4">
                A
            </div>
            <h2 id="userName" class="text-xl font-bold text-gray-800 mb-2">用户名</h2>
            <p id="userEmail" class="text-gray-600 mb-4">user@example.com</p>
            <div class="bg-blue-50 rounded-lg p-4 mb-6">
                <div class="flex items-center justify-between">
                    <span class="text-gray-700">学习时长</span>
                    <span id="studyTime" class="font-bold text-blue-600">0 小时</span>
                </div>
            </div>
            <div class="space-y-3">
                <button 
                    id="profileBtn" 
                    class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg transition-colors"
                >
                    <i class="fas fa-user mr-2"></i>个人中心
                </button>
                <button 
                    id="leaderboardBtn" 
                    class="w-full bg-purple-500 hover:bg-purple-600 text-white py-2 rounded-lg transition-colors"
                >
                    <i class="fas fa-trophy mr-2"></i>卷王排名
                </button>
                <button 
                    id="leaderboardBtn" 
                    class="w-full bg-purple-500 hover:bg-purple-600 text-white py-2 rounded-lg transition-colors"
                >
                    <i class="fas fa-trophy mr-2"></i>卷王排名
                </button>
                <button 
                    id="logoutBtn" 
                    class="w-full bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg transition-colors"
                >
                    <i class="fas fa-sign-out-alt mr-2"></i>退出登录
                </button>
            </div>
        </div>
    </div>

    <script>
        // API基础URL
        const API_BASE = 'http://localhost:5000/api/auth';
        
        // DOM元素
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const switchToRegister = document.getElementById('switchToRegister');
        const switchToLogin = document.getElementById('switchToLogin');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const userProfile = document.getElementById('userProfile');
        
        // 显示错误信息
        function showError(message) {
            document.getElementById('errorText').textContent = message;
            errorMessage.classList.remove('hidden');
            successMessage.classList.add('hidden');
        }
        
        // 显示成功信息
        function showSuccess(message) {
            document.getElementById('successText').textContent = message;
            successMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
        }
        
        // 隐藏所有消息
        function hideMessages() {
            errorMessage.classList.add('hidden');
            successMessage.classList.add('hidden');
        }
        
        // 切换到注册表单
        switchToRegister.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            switchToRegister.classList.add('hidden');
            switchToLogin.classList.remove('hidden');
            hideMessages();
        });
        
        // 切换到登录表单
        switchToLogin.addEventListener('click', () => {
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            switchToLogin.classList.add('hidden');
            switchToRegister.classList.remove('hidden');
            hideMessages();
        });
        
        // 登录处理
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessages();
            
            const formData = new FormData(loginForm);
            const data = {
                username: formData.get('username'),
                password: formData.get('password')
            };
            
            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // 保存用户信息和token
                    localStorage.setItem('userToken', result.data.token);
                    localStorage.setItem('userInfo', JSON.stringify(result.data));
                    
                    // 刷新导航栏状态
                    if (window.navbarManager) {
                        window.navbarManager.refresh();
                    }
                    
                    showSuccess('登录成功！');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                } else {
                    showError(result.message);
                }
            } catch (error) {
                console.error('登录失败:', error);
                showError('登录失败，请检查网络连接');
            }
        });
        
        // 注册处理
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessages();
            
            const formData = new FormData(registerForm);
            const password = formData.get('password');
            const confirmPassword = formData.get('confirmPassword');
            
            if (password !== confirmPassword) {
                showError('两次输入的密码不一致');
                return;
            }
            
            const data = {
                username: formData.get('username'),
                email: formData.get('email'),
                password: password,
                school: formData.get('school')
            };
            
            try {
                const response = await fetch(`${API_BASE}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // 保存用户信息和token
                    localStorage.setItem('userToken', result.data.token);
                    localStorage.setItem('userInfo', JSON.stringify(result.data));
                    
                    // 刷新导航栏状态
                    if (window.navbarManager) {
                        window.navbarManager.refresh();
                    }
                    
                    showSuccess('注册成功！');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                } else {
                    showError(result.message);
                }
            } catch (error) {
                console.error('注册失败:', error);
                showError('注册失败，请检查网络连接');
            }
        });
        
        // 显示用户资料
        function showUserProfile(userData) {
            document.querySelector('.auth-card').classList.add('hidden');
            userProfile.classList.remove('hidden');
            
            document.getElementById('userAvatar').textContent = userData.avatar_letter;
            document.getElementById('userName').textContent = userData.username;
            document.getElementById('userEmail').textContent = userData.email;
            document.getElementById('studyTime').textContent = `${Math.round(userData.study_time / 3600 * 10) / 10} 小时`;
        }
        
        // 退出登录
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('userToken');
            localStorage.removeItem('userInfo');
            
            userProfile.classList.add('hidden');
            document.querySelector('.auth-card').classList.remove('hidden');
            
            // 重置表单
            loginForm.reset();
            registerForm.reset();
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            switchToLogin.classList.add('hidden');
            switchToRegister.classList.remove('hidden');
            hideMessages();
        });
        
        // 个人中心按钮跳转（已由统一导航栏管理）
        // document.getElementById('profileBtn').addEventListener('click', function() {
        //     window.location.href = 'profile.html';
        // });
        
        // 卷王排名按钮跳转（已由统一导航栏管理）
        // document.getElementById('leaderboardBtn').addEventListener('click', () => {
        //     window.location.href = 'leaderboard.html';
        // });
        
        // 页面加载时检查登录状态
        window.addEventListener('load', () => {
            const token = localStorage.getItem('userToken');
            const userInfo = localStorage.getItem('userInfo');
            
            if (token && userInfo) {
                try {
                    const userData = JSON.parse(userInfo);
                    showUserProfile(userData);
                } catch (error) {
                    console.error('解析用户信息失败:', error);
                    localStorage.removeItem('userToken');
                    localStorage.removeItem('userInfo');
                }
            }
        });
    </script>
    
    <!-- 学校数据库 -->
    <script src="js/schools-data.js"></script>
    
    <!-- 学校智能匹配功能 -->
    <script>
        // 学校输入框智能匹配功能
        const schoolInput = document.getElementById('registerSchool');
        const schoolSuggestions = document.getElementById('schoolSuggestions');
        let selectedSchoolIndex = -1;
        
        schoolInput.addEventListener('input', function() {
            const query = this.value.trim();
            if (query.length === 0) {
                schoolSuggestions.classList.add('hidden');
                return;
            }
            
            const matches = searchSchools(query);
            displaySchoolSuggestions(matches.slice(0, 10)); // 最多显示10个建议
        });
        
        function displaySchoolSuggestions(schools) {
            if (schools.length === 0) {
                schoolSuggestions.classList.add('hidden');
                return;
            }
            
            schoolSuggestions.innerHTML = '';
            schools.forEach((school, index) => {
                const div = document.createElement('div');
                div.className = 'px-4 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0';
                div.textContent = school;
                div.addEventListener('click', () => selectSchool(school));
                schoolSuggestions.appendChild(div);
            });
            
            schoolSuggestions.classList.remove('hidden');
            selectedSchoolIndex = -1;
        }
        
        function selectSchool(school) {
            schoolInput.value = school;
            schoolSuggestions.classList.add('hidden');
        }
        
        // 键盘导航
        schoolInput.addEventListener('keydown', function(e) {
            const suggestions = schoolSuggestions.querySelectorAll('div');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedSchoolIndex = Math.min(selectedSchoolIndex + 1, suggestions.length - 1);
                updateSelectedSuggestion(suggestions);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedSchoolIndex = Math.max(selectedSchoolIndex - 1, -1);
                updateSelectedSuggestion(suggestions);
            } else if (e.key === 'Enter' && selectedSchoolIndex >= 0) {
                e.preventDefault();
                selectSchool(suggestions[selectedSchoolIndex].textContent);
            } else if (e.key === 'Escape') {
                schoolSuggestions.classList.add('hidden');
                selectedSchoolIndex = -1;
            }
        });
        
        function updateSelectedSuggestion(suggestions) {
            suggestions.forEach((suggestion, index) => {
                if (index === selectedSchoolIndex) {
                    suggestion.classList.add('bg-blue-100');
                } else {
                    suggestion.classList.remove('bg-blue-100');
                }
            });
        }
        
        // 点击外部关闭建议列表
        document.addEventListener('click', function(e) {
            if (!schoolInput.contains(e.target) && !schoolSuggestions.contains(e.target)) {
                schoolSuggestions.classList.add('hidden');
            }
        });
    </script>
    
    <!-- 统一导航栏组件 -->
    <script src="js/unified-navbar.js"></script>
    </div> <!-- 关闭主要内容区域 -->
</body>
</html>